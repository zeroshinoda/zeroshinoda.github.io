<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanji Flashcards</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-content::-webkit-scrollbar { width: 6px; }
        .card-content::-webkit-scrollbar-track { background: transparent; }
        .card-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .no-select { user-select: none; -webkit-user-select: none; }
        @keyframes fadeOutLeft { to { transform: translateX(-150%) rotate(-30deg); opacity: 0; } }
        @keyframes fadeOutRight { to { transform: translateX(150%) rotate(30deg); opacity: 0; } }
        .animate-swipe-left { animation: fadeOutLeft 0.3s forwards; }
        .animate-swipe-right { animation: fadeOutRight 0.3s forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 touch-none overscroll-none">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Settings = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const RotateCcw = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>);
        const ToggleLeft = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="12" x="2" y="6" rx="6" ry="6"/><circle cx="8" cy="12" r="2"/></svg>);
        const ToggleRight = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="12" x="2" y="6" rx="6" ry="6"/><circle cx="16" cy="12" r="2"/></svg>);
        const BookOpen = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>);
        const Zap = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>);

        // --- UTILS ---
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return []; 
            const data = [];
            const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const matches = [];
                let match = regex.exec(line);
                while (match) {
                    let val = match[1] || match[0];
                    if (val.startsWith(',')) val = val.substring(1);
                    if (val.startsWith('"') && val.endsWith('"')) { val = val.substring(1, val.length - 1).replace(/""/g, '"'); }
                    matches.push(val.trim());
                    match = regex.exec(line);
                    if (match && match.index === regex.lastIndex) regex.lastIndex++; 
                    if (matches.length >= 8) break; 
                }
                const row = matches.length > 0 ? matches : line.split(','); 
                if (row.length >= 7) data.push(transformRow(row));
            }
            return data;
        };

        const transformRow = (row) => {
            const [kanji, level, hanviet, onKanaStr, onRomajiStr, kunKanaStr, kunRomajiStr, examplesStr] = row;
            const parseReadings = (k, r) => {
                if (!k || k === 'null') return [];
                const ks = k.split(',').map(s => s.trim());
                const rs = r ? r.split(',').map(s => s.trim()) : [];
                return ks.map((v, i) => ({ kana: v, romaji: rs[i] || '' }));
            };
            const parseExamples = (exStr) => {
                if (!exStr) return [];
                return exStr.split(';').map(raw => {
                    const match = raw.match(/([^(]+)\s*\(([^)]+)\)\s*\[([^\]]+)\]:\s*(.+)/);
                    if (match) return { text: match[1].trim(), furi: match[2].trim(), romaji: match[3].trim(), mean: match[4].trim() };
                    return { text: raw.trim(), furi: '', romaji: '', mean: '' };
                }).filter(e => e.text);
            };
            return {
                id: Math.random().toString(36).substr(2, 9), 
                kanji: kanji, level: parseInt(level) || 5, hanviet: hanviet,
                on: parseReadings(onKanaStr, onRomajiStr), kun: parseReadings(kunKanaStr, kunRomajiStr),
                examples: parseExamples(examplesStr)
            };
        };

        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        // --- COMPONENTS ---
        const FuriganaText = ({ text, furi, romaji, showRomaji }) => (
            <div className="flex flex-col items-center justify-center">
                <div className="text-[10px] text-slate-500 leading-none mb-0.5 min-h-[10px]">{furi}</div>
                <div className="text-lg leading-none font-medium text-slate-800">{text}</div>
                {showRomaji && <div className="text-[10px] text-rose-500 font-medium leading-tight mt-0.5 animate-in fade-in">{romaji}</div>}
            </div>
        );

        const LevelSelector = ({ onSelect, title, description, showCount }) => {
            const levels = [
                { val: 5, label: "N5", desc: "Beginner" }, { val: 4, label: "N4", desc: "Basic" },
                { val: 3, label: "N3", desc: "Intermediate" }, { val: 2, label: "N2", desc: "Advanced" }, { val: 1, label: "N1", desc: "Native" },
            ];
            return (
                <div className="h-screen flex flex-col p-6 bg-slate-50">
                    <button onClick={() => onSelect(null)} className="text-slate-400 mb-6 font-bold self-start">‚Üê Back</button>
                    <h2 className="text-2xl font-bold mb-2">{title}</h2>
                    <p className="text-sm text-slate-400 mb-6">{description}</p>
                    <div className="grid gap-3">
                        {levels.map(l => (
                            <button key={l.val} onClick={() => onSelect(l.val)}
                                className="w-full text-left p-4 bg-white rounded-xl shadow-sm border border-slate-100 flex justify-between items-center hover:border-rose-300 active:scale-95 transition-all">
                                <div><div className="font-bold text-xl text-slate-800">{l.label}</div><div className="text-xs text-slate-400">{l.desc}</div></div>
                                <div className="flex items-center gap-3">
                                    {showCount && <span className="text-xs text-slate-400 font-medium">All Cards</span>}
                                    <div className="w-8 h-8 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center">‚Üí</div>
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [kanjiData, setKanjiData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [mode, setMode] = useState('menu'); 
            const [deck, setDeck] = useState([]);
            const [finishedCount, setFinishedCount] = useState(0);
            const [initialDeckSize, setInitialDeckSize] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showRomaji, setShowRomaji] = useState(true);
            const [dragDelta, setDragDelta] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [swipeResult, setSwipeResult] = useState(null); 
            const dragStartRef = useRef(null);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch('joyo_kanji_final.csv');
                        if (!response.ok) throw new Error("Missing joyo_kanji_final.csv");
                        const text = await response.text();
                        const parsedData = parseCSV(text);
                        if (parsedData.length === 0) throw new Error("CSV empty.");
                        setKanjiData(parsedData); setIsLoading(false);
                    } catch (err) { setError(err.message); setIsLoading(false); }
                };
                loadData();
            }, []);

            const initSession = (selectedDeck) => {
                setDeck(selectedDeck); setInitialDeckSize(selectedDeck.length); setFinishedCount(0);
                setSwipeResult(null); setIsFlipped(false); setDragDelta({ x: 0, y: 0 }); setMode('active');
            };
            const startStudyMode = (level) => {
                if (!level) { setMode('menu'); return; }
                initSession(shuffleArray(kanjiData.filter(k => k.level >= level)));
            };
            const startPracticeMode = (level) => {
                if (!level) { setMode('menu'); return; }
                const pool = kanjiData.filter(k => k.level >= level);
                const count = 10 + ({ 5: 0, 4: 5, 3: 10, 2: 15, 1: 20 }[level] || 0);
                initSession(shuffleArray(pool).slice(0, count));
            };

            const handleSwipeRight = () => { // Studied
                setSwipeResult('right');
                setTimeout(() => {
                    setDeck(prev => prev.slice(1)); setFinishedCount(c => c + 1); setSwipeResult(null); setDragDelta({ x: 0, y: 0 }); setIsFlipped(false);
                }, 300);
            };
            const handleSwipeLeft = () => { // Practice More
                setSwipeResult('left');
                const currentCard = deck[0];
                setTimeout(() => {
                    setDeck(prev => {
                        const remaining = prev.slice(1);
                        if (remaining.length === 0) return [currentCard]; 
                        const insertIdx = Math.floor(Math.random() * remaining.length) + 1;
                        const newDeck = [...remaining]; newDeck.splice(insertIdx, 0, currentCard); return newDeck;
                    });
                    setSwipeResult(null); setDragDelta({ x: 0, y: 0 }); setIsFlipped(false);
                }, 300);
            };

            const handlePointerDown = (e) => {
                if (swipeResult) return;
                setIsDragging(true);
                dragStartRef.current = { x: e.clientX || e.touches[0].clientX, y: e.clientY || e.touches[0].clientY };
            };
            const handlePointerMove = (e) => {
                if (!isDragging || !dragStartRef.current) return;
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                setDragDelta({ x: clientX - dragStartRef.current.x, y: 0 });
            };
            const handlePointerUp = () => {
                if (!isDragging) return;
                setIsDragging(false);
                if (dragDelta.x > 100) handleSwipeRight();
                else if (dragDelta.x < -100) handleSwipeLeft();
                else setDragDelta({ x: 0, y: 0 });
            };
            const handleClick = () => { if (Math.abs(dragDelta.x) < 10) setIsFlipped(!isFlipped); };

            if (isLoading) return <div className="h-screen flex items-center justify-center text-slate-500">Loading Kanji...</div>;
            if (error) return <div className="p-10 text-center text-red-500">{error}</div>;

            if (mode === 'menu') {
                return (
                    <div className="h-screen flex flex-col items-center justify-center p-6 bg-slate-50">
                        <div className="mb-10 text-center"><h1 className="text-4xl font-bold text-slate-800 mb-2">Kanji<span className="text-rose-500">Master</span></h1><p className="text-slate-400">Master Japanese Characters</p></div>
                        <div className="w-full max-w-sm space-y-4">
                            <button onClick={() => setMode('setup-study')} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg shadow-slate-200 flex items-center justify-center gap-3 active:scale-95 transition-transform"><BookOpen className="w-6 h-6" /><span>Study Mode</span></button>
                            <button onClick={() => setMode('setup-practice')} className="w-full py-4 bg-white text-rose-500 border-2 border-rose-100 rounded-2xl font-bold shadow-sm flex items-center justify-center gap-3 active:scale-95 transition-transform hover:bg-rose-50"><Zap className="w-6 h-6" /><span>Quick Practice</span></button>
                        </div>
                    </div>
                );
            }
            if (mode === 'setup-study') return <LevelSelector onSelect={startStudyMode} title="Select Study Level" description="Study all kanji from this level and below." showCount={true} />;
            if (mode === 'setup-practice') return <LevelSelector onSelect={startPracticeMode} title="Select Practice Level" description="A quick random session with a mix of cards." showCount={false} />;

            const currentCard = deck[0];
            if (!currentCard && mode === 'active') {
                return (
                    <div className="h-screen flex flex-col items-center justify-center p-6 text-center">
                        <div className="text-6xl mb-4">üéâ</div><h2 className="text-2xl font-bold text-slate-800 mb-2">Session Complete!</h2><p className="text-slate-500 mb-8">You studied {finishedCount} cards.</p>
                        <button onClick={() => setMode('menu')} className="px-8 py-3 bg-rose-500 text-white rounded-full font-bold shadow-lg shadow-rose-200">Back to Menu</button>
                    </div>
                );
            }

            const progress = initialDeckSize > 0 ? (finishedCount / initialDeckSize) * 100 : 0;
            const rotateDeg = dragDelta.x * 0.1;
            const cardStyle = { transform: `translateX(${dragDelta.x}px) rotate(${rotateDeg}deg)`, transition: isDragging ? 'none' : 'transform 0.3s ease-out', cursor: isDragging ? 'grabbing' : 'grab' };
            let animClass = ''; if (swipeResult === 'left') animClass = 'animate-swipe-left'; if (swipeResult === 'right') animClass = 'animate-swipe-right';

            return (
                <div className="h-screen flex flex-col overflow-hidden bg-slate-50 relative selection:bg-rose-200">
                    <header className="px-6 py-4 flex justify-between items-center z-10">
                        <div className="flex items-center gap-2"><button onClick={() => setMode('menu')} className="text-slate-400 hover:text-slate-600"><RotateCcw className="w-5 h-5" /></button><span className="text-sm font-bold text-slate-400">{finishedCount + 1} / {initialDeckSize + deck.length - 1}</span></div>
                        <button onClick={() => setShowSettings(true)} className="text-slate-400 hover:text-slate-600"><Settings className="w-6 h-6" /></button>
                    </header>
                    <div className="w-full h-1 bg-slate-200"><div className="h-full bg-rose-500 transition-all duration-500" style={{ width: `${progress}%` }}></div></div>

                    <main className="flex-1 flex flex-col items-center justify-center p-4 relative w-full max-w-md mx-auto perspective-1000">
                        <div className={`relative w-full aspect-[3/4] ${animClass}`} style={cardStyle}
                             onMouseDown={handlePointerDown} onMouseMove={handlePointerMove} onMouseUp={handlePointerUp} onMouseLeave={handlePointerUp} onTouchStart={handlePointerDown} onTouchMove={handlePointerMove} onTouchEnd={handlePointerUp}>
                            <div className="absolute top-8 left-8 border-4 border-green-500 text-green-500 font-bold text-3xl px-4 py-2 rounded-xl transform -rotate-12 z-50 pointer-events-none" style={{ opacity: Math.max(dragDelta.x/100, 0) }}>STUDIED</div>
                            <div className="absolute top-8 right-8 border-4 border-rose-500 text-rose-500 font-bold text-3xl px-4 py-2 rounded-xl transform rotate-12 z-50 pointer-events-none" style={{ opacity: Math.max(-dragDelta.x/100, 0) }}>PRACTICE</div>

                            <div className={`w-full h-full relative transition-transform duration-500 transform-style-3d shadow-2xl rounded-3xl bg-white`} style={{ transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }} onClick={handleClick}>
                                <div className="absolute inset-0 backface-hidden rounded-3xl flex flex-col items-center justify-center border border-slate-100 bg-white overflow-hidden z-20">
                                    <div className="absolute top-[-50px] right-[-50px] w-40 h-40 bg-rose-50 rounded-full blur-2xl opacity-50 pointer-events-none"></div>
                                    <div className="relative z-10 flex flex-col items-center pointer-events-none no-select">
                                        <div className="text-xs font-bold text-rose-200 mb-4">N{currentCard.level}</div><span className="text-9xl font-light text-slate-800 mb-8 font-serif">{currentCard.kanji}</span><span className="text-xs text-slate-300 font-medium uppercase tracking-widest">Tap to flip</span>
                                    </div>
                                </div>
                                <div className="absolute inset-0 backface-hidden rotate-y-180 rounded-3xl flex flex-col p-6 border border-slate-100 bg-white overflow-hidden z-20">
                                    <div className="card-content h-full overflow-y-auto pr-1">
                                        <div className="flex items-start justify-between border-b border-slate-100 pb-4 mb-4">
                                            <div className="text-5xl font-serif text-slate-800">{currentCard.kanji}</div><div className="text-right"><div className="text-xs text-slate-400 uppercase tracking-wider mb-1">H√°n Vi·ªát</div><div className="text-xl font-bold text-rose-600">{currentCard.hanviet}</div></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                            <div className="bg-slate-50 p-2 rounded-lg"><div className="text-[10px] text-slate-400 font-bold mb-1 uppercase">Onyomi</div><div className="flex flex-wrap gap-2">{currentCard.on.map((r, i) => (<div key={i}><span className="text-sm font-bold text-slate-700">{r.kana}</span>{showRomaji && <div className="text-[9px] text-rose-400">{r.romaji}</div>}</div>))}</div></div>
                                            <div className="bg-slate-50 p-2 rounded-lg"><div className="text-[10px] text-slate-400 font-bold mb-1 uppercase">Kunyomi</div><div className="flex flex-wrap gap-2">{currentCard.kun.map((r, i) => (<div key={i}><span className="text-sm font-bold text-slate-700">{r.kana}</span>{showRomaji && <div className="text-[9px] text-rose-400">{r.romaji}</div>}</div>))}</div></div>
                                        </div>
                                        <div className="space-y-3">
                                            {currentCard.examples.map((ex, i) => (
                                                <div key={i} className="flex items-start justify-between pb-2 border-b border-slate-50 last:border-0"><div className="flex items-center gap-2"><div className="w-0.5 h-8 bg-rose-200"></div><FuriganaText text={ex.text} furi={ex.furi} romaji={ex.romaji} showRomaji={showRomaji} /></div><div className="text-xs text-slate-500 text-right w-1/2 pt-1 leading-tight">{ex.mean}</div></div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer className="p-4 text-center text-xs text-slate-400 pb-8 flex justify-center gap-8 opacity-60">
                        <div className="flex flex-col items-center gap-1"><div className="w-8 h-8 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center">‚Üê</div><span>Practice More</span></div>
                        <div className="flex flex-col items-center gap-1"><div className="w-8 h-8 rounded-full bg-green-100 text-green-500 flex items-center justify-center">‚Üí</div><span>Studied</span></div>
                    </footer>

                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onClick={() => setShowSettings(false)}></div>
                            <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl relative z-10 p-6">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-800">Settings</h2><button onClick={() => setShowSettings(false)} className="p-1">‚úï</button></div>
                                <div className="bg-slate-50 p-4 rounded-xl flex items-center justify-between mb-4">
                                    <div><div className="font-bold text-slate-700">Show Romaji</div><div className="text-xs text-slate-500">Pronunciation guide</div></div>
                                    <button onClick={() => setShowRomaji(!showRomaji)} className="text-rose-500">{showRomaji ? <ToggleRight className="w-10 h-10 fill-current" /> : <ToggleLeft className="w-10 h-10 text-slate-300" />}</button>
                                </div>
                                <div className="text-center"><button onClick={() => { setMode('menu'); setShowSettings(false); }} className="text-sm text-red-500 font-bold">End Session & Return to Menu</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>