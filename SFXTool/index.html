<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bunny SFX Lab</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&family=Nunito:wght@800&display=swap');

        body {
            background-color: #0f0f13;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* --- FIXED RANGE SLIDERS --- */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #27272a;
            cursor: pointer;
            margin: 10px 0;
        }
        
        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 100%;
            background: transparent; 
            border-radius: 4px;
            border: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #d4d4d8;
            margin-top: -5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }

        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.1);
            background: #f4f4f5;
        }

        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: transparent;
            border-radius: 4px;
        }
        input[type=range]::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border: 2px solid #d4d4d8;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
        }

        /* --- VERTICAL TABS --- */
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 0.15em;
        }

        .tab-btn {
            border-left: 3px solid transparent;
            transition: all 0.1s ease-in-out;
            /* Fix for jumping text: Flexbox centering ensures text stays put */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tab-btn.active {
            color: #f472b6;
            background: linear-gradient(to left, rgba(244, 114, 182, 0.1), transparent);
            border-left: 3px solid #f472b6;
        }

        .panel {
            background: #18181b;
            border: 1px solid #27272a;
        }
        
        .btn-retro {
            border-bottom: 3px solid rgba(0,0,0,0.3);
            transition: transform 0.05s;
        }
        .btn-retro:active {
            transform: translateY(2px);
            border-bottom: 1px solid rgba(0,0,0,0.3);
        }

        /* Toast Animation */
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .toast {
            animation: fadeOut 0.5s ease-out 2s forwards;
        }
        
        /* History Item Animation */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .history-item {
            animation: slideIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="absolute top-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>

    <!-- Header -->
    <div class="bg-neutral-900 p-4 border-b border-neutral-800 flex justify-between items-center shrink-0 relative overflow-hidden z-20">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-pink-500 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
        <div class="flex items-center gap-4 relative z-10">
            <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c-3 0-5 2-5 5v2a5 5 0 0 0 10 0V7c0-3-2-5-5-5z"/><path d="M7 17a5 5 0 0 0 10 0"/><path d="M7 17v-3"/><path d="M17 17v-3"/><line x1="9" y1="10" x2="9.01" y2="10"/><line x1="15" y1="10" x2="15.01" y2="10"/><path d="M9 14s1.5 1 3 1 3-1 3-1"/></svg>
            </div>
            <div>
                <h1 class="text-xl font-extrabold tracking-tight text-white font-['Nunito']">BUNNY <span class="text-pink-500">SFX LAB</span></h1>
                <div class="text-[10px] text-zinc-400 flex items-center gap-2 font-mono">
                    <span>v3.7.1 Web</span>
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span id="status-text">System Ready</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="flex-grow p-4 grid grid-cols-12 gap-4 overflow-hidden h-full">
        
        <!-- LEFT COLUMN -->
        <div class="col-span-12 lg:col-span-4 flex flex-col gap-4 h-full min-h-0">
            
            <!-- 1. Oscilloscope -->
            <div class="panel rounded-xl p-3 h-32 bg-black border-zinc-800 shrink-0 relative">
                <div class="absolute top-2 left-3 text-[10px] font-bold text-zinc-600 tracking-widest">OSCILLOSCOPE</div>
                <canvas id="scope" class="w-full h-full block"></canvas>
            </div>

            <!-- 2. Presets -->
            <div class="panel rounded-xl flex flex-row overflow-hidden flex-grow relative min-h-0">
                <!-- Sidebar Tabs: UPDATED (w-16, overflow-y-auto) -->
                <div class="w-16 bg-neutral-900 border-r border-neutral-800 flex flex-col items-center py-2 shrink-0 z-10 custom-scrollbar overflow-y-auto overflow-x-hidden">
                    <button class="tab-btn active w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="magic">MAGIC</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="scifi">SCIFI</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="rpg">RPG</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="arcade">ARCADE</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="ui">UI</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="voice">VOICE</button>
                    <button class="tab-btn w-full py-6 text-[10px] font-bold text-zinc-500 hover:text-white vertical-text transition-all" data-tab="retro">RETRO</button>
                </div>
                <!-- Preset Grid -->
                <div class="flex-grow bg-zinc-900/50 p-4 overflow-y-auto custom-scrollbar" id="preset-container"></div>
            </div>

            <!-- 3. History -->
            <div class="panel rounded-xl flex flex-col h-48 shrink-0 overflow-hidden">
                <div class="bg-neutral-900 px-4 py-2 border-b border-neutral-800 flex justify-between items-center">
                    <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left mr-1 text-pink-500"></i> Recent History</span>
                    <span class="text-[9px] text-zinc-600">LAST 10</span>
                </div>
                <div id="history-container" class="p-2 overflow-y-auto custom-scrollbar bg-zinc-900/30 flex flex-col gap-1 flex-grow">
                    <div class="text-zinc-600 text-[10px] text-center mt-10 italic">No history yet.<br>Generate some noise!</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-span-12 lg:col-span-8 flex flex-col gap-4 h-full min-h-0">
            
            <!-- Controls Area -->
            <div class="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-4 pr-1">
                <!-- Top Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Oscillator -->
                    <div class="panel rounded-xl p-4 border-t-4 border-pink-600">
                        <h2 class="font-bold text-pink-500 mb-4 text-sm flex items-center gap-2"><i class="fa-solid fa-wave-square"></i> OSCILLATOR</h2>
                        <div class="flex bg-black/40 rounded p-1 gap-1 mb-4">
                            <button class="wave-btn flex-1 py-1 text-[10px] font-bold rounded bg-pink-600 text-white" data-wave="square">SQR</button>
                            <button class="wave-btn flex-1 py-1 text-[10px] font-bold rounded hover:bg-zinc-700 text-zinc-400" data-wave="sawtooth">SAW</button>
                            <button class="wave-btn flex-1 py-1 text-[10px] font-bold rounded hover:bg-zinc-700 text-zinc-400" data-wave="sine">SIN</button>
                            <button class="wave-btn flex-1 py-1 text-[10px] font-bold rounded hover:bg-zinc-700 text-zinc-400" data-wave="triangle">TRI</button>
                            <button class="wave-btn flex-1 py-1 text-[10px] font-bold rounded hover:bg-zinc-700 text-zinc-400" data-wave="noise">NOIZ</button>
                        </div>
                        <div class="space-y-2">
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Freq</span><span id="val-freq" class="text-pink-400">440 Hz</span></div><input type="range" id="p-freq" min="50" max="2000" value="440" class="slider-osc" data-color="#db2777"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Slide</span><span id="val-slide" class="text-pink-400">0</span></div><input type="range" id="p-slide" min="-1200" max="1200" value="0" class="slider-osc" data-color="#db2777"></div>
                        </div>
                    </div>
                    <!-- Modulation -->
                    <div class="panel rounded-xl p-4 border-t-4 border-indigo-500">
                        <h2 class="font-bold text-indigo-400 mb-4 text-sm flex items-center gap-2"><i class="fa-solid fa-rss"></i> MODULATION</h2>
                        <div class="space-y-4 pt-2">
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Vib Depth</span><span id="val-vibrato" class="text-indigo-400">0%</span></div><input type="range" id="p-vibrato" min="0" max="100" value="0" class="slider-mod" data-color="#818cf8"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Vib Speed</span><span id="val-vib_speed" class="text-indigo-400">10 Hz</span></div><input type="range" id="p-vib_speed" min="1" max="50" value="10" class="slider-mod" data-color="#818cf8"></div>
                        </div>
                    </div>
                </div>

                <!-- Middle Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Envelope -->
                    <div class="panel rounded-xl p-4 border-t-4 border-emerald-600">
                        <h2 class="font-bold text-emerald-500 mb-4 text-sm flex items-center gap-2"><i class="fa-solid fa-stopwatch"></i> ENVELOPE (AHDSR)</h2>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Attack</span><span id="val-attack" class="text-emerald-400">0.01s</span></div><input type="range" id="p-attack" min="0.001" max="3.0" step="0.001" value="0.01" class="slider-env" data-color="#059669"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Hold</span><span id="val-hold" class="text-emerald-400">0.10s</span></div><input type="range" id="p-hold" min="0.01" max="3.0" step="0.01" value="0.1" class="slider-env" data-color="#059669"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Decay</span><span id="val-decay" class="text-emerald-400">0.10s</span></div><input type="range" id="p-decay" min="0.01" max="3.0" step="0.01" value="0.1" class="slider-env" data-color="#059669"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Sustain</span><span id="val-sustain" class="text-emerald-400">50%</span></div><input type="range" id="p-sustain" min="0" max="1" step="0.01" value="0.5" class="slider-env" data-color="#059669"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Release</span><span id="val-release" class="text-emerald-400">0.30s</span></div><input type="range" id="p-release" min="0.01" max="5.0" step="0.01" value="0.3" class="slider-env" data-color="#059669"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Punch</span><span id="val-punch" class="text-emerald-400">0%</span></div><input type="range" id="p-punch" min="0" max="100" value="0" class="slider-env" data-color="#059669"></div>
                        </div>
                    </div>
                    <!-- Filter -->
                    <div class="panel rounded-xl p-4 border-t-4 border-amber-600">
                        <h2 class="font-bold text-amber-500 mb-4 text-sm flex items-center gap-2"><i class="fa-solid fa-filter"></i> FILTER & FX</h2>
                        <div class="space-y-2">
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>HP Cut</span><span id="val-hp" class="text-amber-400">0 Hz</span></div><input type="range" id="p-hp" min="0" max="1000" value="0" class="slider-filter" data-color="#d97706"></div>
                            <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>LP Cut</span><span id="val-lp" class="text-amber-400">20000 Hz</span></div><input type="range" id="p-lp" min="200" max="20000" value="20000" class="slider-filter" data-color="#d97706"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Bitcrush</span><span id="val-crush" class="text-amber-400">OFF</span></div><input type="range" id="p-crush" min="1" max="16" step="1" value="16" class="slider-filter" data-color="#d97706"></div>
                                <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Drive</span><span id="val-drive" class="text-amber-400">0</span></div><input type="range" id="p-drive" min="0" max="100" value="0" class="slider-filter" data-color="#d97706"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Tremolo</span><span id="val-tremolo" class="text-amber-400">0</span></div><input type="range" id="p-tremolo" min="0" max="20" value="0" class="slider-filter" data-color="#d97706"></div>
                                <div><div class="flex justify-between text-[10px] font-bold text-zinc-400"><span>Delay</span><span id="val-delay" class="text-amber-400">0</span></div><input type="range" id="p-delay" min="0" max="0.5" step="0.01" value="0" class="slider-filter" data-color="#d97706"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Master Volume -->
                <div class="panel rounded-xl p-4 border-t-4 border-blue-600 flex items-center gap-4">
                    <div class="flex-grow">
                        <div class="flex justify-between text-[10px] font-bold text-zinc-400 mb-1"><span>MASTER VOLUME</span><span id="val-vol" class="text-blue-400">50%</span></div>
                        <input type="range" id="p-vol" min="0" max="1" step="0.01" value="0.5" class="slider-master" data-color="#3b82f6">
                    </div>
                    <div class="bg-black/30 rounded p-2 text-center min-w-[80px]">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold">Duration</div>
                        <div id="val-duration" class="text-lg font-mono text-white">0.00s</div>
                    </div>
                </div>
            </div>

            <!-- Fixed Action Area -->
            <div class="panel rounded-xl p-4 shrink-0 mt-auto z-20">
                <button id="manual-play-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-lg font-black py-4 rounded shadow-lg btn-retro mb-4 flex justify-center items-center gap-2 active:scale-[0.98] transition-transform"><i class="fa-solid fa-play"></i> PLAY MANUAL SOUND</button>
                <div class="flex gap-4">
                    <button onclick="generatePreset('random', 'Randomized')" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded btn-retro text-sm flex justify-center items-center gap-2"><i class="fa-solid fa-shuffle"></i> RANDOMIZE</button>
                    <div class="flex-1 flex bg-zinc-900 rounded border border-zinc-700 p-1">
                        <select id="export-fmt" class="bg-transparent text-zinc-300 text-xs font-bold px-2 outline-none cursor-pointer"><option value="wav">.WAV</option><option value="mp3">.MP3</option></select>
                        <button id="download-btn" class="flex-grow bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded btn-retro text-sm disabled:opacity-50" disabled><i class="fa-solid fa-download mr-2"></i> SAVE</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /* --- PRESET DATA --- */
        const presets={'magic':[['Cast','magic_cast','bg-purple-600'],['Fireball','magic_fire','bg-red-700'],['Ice Shard','magic_ice','bg-cyan-500'],['Thunder','magic_thunder','bg-yellow-500'],['Heal','magic_heal','bg-pink-500'],['Dark Matter','magic_dark','bg-purple-900'],['Warp','magic_warp','bg-fuchsia-600'],['Earth','magic_earth','bg-amber-800'],['Time Stop','magic_time','bg-teal-600'],['Holy','magic_holy','bg-amber-200 text-black'],['Wind','magic_wind','bg-slate-400 text-black'],['Water','magic_water','bg-blue-400 text-black'],['Poison','magic_poison','bg-lime-600'],['Shield','magic_shield','bg-sky-300 text-black'],['Necromancy','magic_necromancy','bg-zinc-700'],['Summon','magic_summon','bg-rose-700']],'scifi':[['Thruster','scifi_thruster','bg-orange-600'],['Scanner','scifi_scanner','bg-cyan-600'],['Droid','scifi_droid','bg-blue-500'],['Forcefield','scifi_forcefield','bg-violet-600'],['Alarm','scifi_alarm','bg-red-600'],['Laser','scifi_laser_cannon','bg-rose-500'],['Warp Drive','scifi_warp_drive','bg-indigo-700'],['Teleport','scifi_teleport','bg-sky-500'],['Data','scifi_data','bg-emerald-700'],['Power Down','scifi_powerdown','bg-gray-600'],['Shield Hit','scifi_shield_hit','bg-amber-600']],'rpg':[['Sword','rpg_sword','bg-slate-500'],['Block','rpg_block','bg-stone-600'],['Potion','rpg_potion','bg-pink-600'],['Level Up','rpg_levelup','bg-yellow-500 text-black'],['Crit','rpg_crit','bg-red-800'],['Footstep','rpg_footstep','bg-amber-800'],['Quest','rpg_quest','bg-emerald-600'],['Bow','rpg_bow','bg-orange-700'],['Growl','rpg_growl','bg-red-900'],['Menu','rpg_menu','bg-zinc-600'],['Miss','rpg_miss','bg-gray-500']],'arcade':[['Coin','pickup','bg-yellow-600'],['Jump','jump','bg-blue-600'],['Laser','laser','bg-red-600'],['Explosion','explosion','bg-orange-700'],['Powerup','powerup','bg-green-600'],['Hit','hit','bg-purple-600'],['Blip','blip','bg-cyan-600'],['Game Over','gameover','bg-gray-600'],['1-Up','arcade_1up','bg-green-500'],['Checkpoint','arcade_checkpoint','bg-indigo-500'],['Shoot','arcade_shoot','bg-red-500'],['Enemy Death','arcade_enemy_death','bg-amber-700'],['Pause','arcade_pause','bg-slate-500'],['Secret','arcade_secret','bg-yellow-400 text-black']],'ui':[['Click','ui_click','bg-slate-600'],['Switch','ui_switch','bg-slate-700'],['Confirm','ui_confirm','bg-emerald-600'],['Error','ui_error','bg-red-800'],['Back','ui_back','bg-slate-500'],['Type','ui_type','bg-neutral-600'],['Notify','ui_notify','bg-blue-500'],['Hover','ui_hover','bg-slate-400 text-black'],['Purchase','ui_purchase','bg-green-500'],['Delete','ui_delete','bg-red-600'],['Popup','ui_popup','bg-sky-500'],['Toggle On','ui_toggle_on','bg-emerald-500'],['Toggle Off','ui_toggle_off','bg-slate-500']],'voice':[['High','voice_animal_high','bg-sky-500'],['Medium','voice_animal_med','bg-sky-700'],['Low','voice_animal_low','bg-stone-700'],['Robot','voice_robot','bg-zinc-500'],['Whistle','voice_whistle','bg-yellow-600'],['Ghost','voice_ghost','bg-indigo-400'],['Demon','voice_demon','bg-red-900'],['Alien','voice_alien','bg-lime-500'],['Insect','voice_insect','bg-amber-500']],'retro':[['Static','retro_noise_short','bg-gray-500'],['Slide Up','retro_square_slide','bg-pink-600'],['Fall','retro_fall','bg-pink-800'],['Buzz','retro_buzz','bg-orange-600'],['Modem','retro_modem','bg-blue-700'],['Teleport','retro_teleport','bg-cyan-400 text-black'],['Engine','retro_engine','bg-stone-600'],['Glitch','retro_glitch','bg-fuchsia-500']]};
        const tabContainer = document.getElementById('preset-container');
        const historyContainer = document.getElementById('history-container');
        let historyList = [];
        
        function addToHistory(label, config) {
            const configCopy = {...config};
            historyList.unshift({ label: label, config: configCopy });
            if(historyList.length > 10) historyList.pop();
            renderHistory();
        }

        function renderHistory() {
            historyContainer.innerHTML = '';
            if (historyList.length === 0) {
                historyContainer.innerHTML = '<div class="text-zinc-600 text-[10px] text-center mt-10 italic">No history yet.<br>Generate some noise!</div>';
                return;
            }
            
            historyList.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = `history-item w-full p-2 rounded font-bold text-[10px] flex items-center gap-2 text-zinc-300 hover:text-white hover:bg-zinc-700 bg-zinc-800 border border-zinc-700 text-left transition-colors mb-1`;
                
                const icon = `<span class="text-pink-500"><i class="fa-solid fa-clock-rotate-left"></i></span>`;
                btn.innerHTML = `${icon} ${item.label} <span class="text-zinc-500 font-mono text-[10px] mr-auto ml-2">#${index + 1}</span>`;
                btn.onclick = () => setUI(item.config);
                historyContainer.appendChild(btn);
            });
        }

        function renderPresets(category) {
            tabContainer.innerHTML = '';
            const items = presets[category];
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-3';
            
            items.forEach(([label, code, colorClass]) => {
                const btn = document.createElement('button');
                btn.className = `btn-retro p-3 rounded font-bold text-xs flex flex-col items-center justify-center gap-1 text-white hover:opacity-90 ${colorClass}`;
                if(colorClass.includes('text-black')) btn.classList.remove('text-white');
                
                btn.innerHTML = `<span class="text-lg opacity-80"><i class="fa-solid fa-wave-square"></i></span>${label}`;
                btn.onclick = () => generatePreset(code, label);
                grid.appendChild(btn);
            });
            tabContainer.appendChild(grid);
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-white'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('text-zinc-500'));
                btn.classList.add('active', 'text-white');
                btn.classList.remove('text-zinc-500');
                renderPresets(btn.dataset.tab);
            });
        });

        /* --- AUDIO ENGINE --- */
        let audioCtx;
        let masterGain;
        let analyser;
        let lastBuffer = null; 
        let autoPlay = true;

        // State
        const state = {
            wave: 'square', freq: 440, slide: 0, 
            vibrato: 0, vib_speed: 10,
            attack: 0.01, hold: 0.1, decay: 0.1, sustain: 0.5, release: 0.3, punch: 0,
            hp: 0, lp: 20000, crush: 16, tremolo: 0, volume: 0.5,
            drive: 0, delay: 0
        };

        /* --- VISUALIZER (Setup) --- */
        const canvas = document.getElementById('scope');
        const canvasCtx = canvas.getContext('2d');
        
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!analyser) return;

            const width = canvas.width;
            const height = canvas.height;
            
            analyser.fftSize = 2048;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            canvasCtx.fillStyle = '#000000';
            canvasCtx.fillRect(0, 0, width, height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#f472b6';
            canvasCtx.beginPath();

            const sliceWidth = width * 1.0 / bufferLength;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * height / 2;

                if(i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }

            canvasCtx.lineTo(canvas.width, canvas.height/2);
            canvasCtx.stroke();
        }
        
        // Handle Resize for Canvas
        function resizeCanvas() {
            if(canvas.parentElement) {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
            }
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function autoInit() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                masterGain.connect(analyser);
                document.getElementById('status-text').textContent = "Audio Engine Active";
                drawVisualizer();
                // Initialize first tab after audio context is ready to ensure no startup lag issues
                renderPresets('magic'); 
                document.body.removeEventListener('click', autoInit);
                document.body.removeEventListener('keydown', autoInit);
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        document.body.addEventListener('click', autoInit);
        document.body.addEventListener('keydown', autoInit);

        function makeDistortionCurve(amount) {
            if (amount === 0) return null;
            const k = amount, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = (i * 2) / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }
        
        function makeBitcrushCurve(bits) {
             const steps = Math.pow(2, bits);
             const n_samples = 44100;
             const curve = new Float32Array(n_samples);
             for (let i = 0; i < n_samples; i++) {
                 const x = (i * 2) / n_samples - 1;
                 curve[i] = Math.round(x * steps) / steps;
             }
             return curve;
        }

        async function playSound(renderOffline = false) {
            if (!audioCtx && !renderOffline) return;
            if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();

            let ctx = audioCtx;
            let dest = masterGain;
            
            const rawDuration = state.attack + state.hold + state.decay + state.release;
            const tail = state.delay > 0 ? 0.5 : 0.1; 
            const duration = Math.min(Math.max(rawDuration, 0.1), 10.0) + tail;

            if (renderOffline) {
                ctx = new OfflineAudioContext(1, 44100 * duration, 44100);
                dest = ctx.destination;
            }

            const t = ctx.currentTime;
            
            // 1. Source Node
            let sourceNode;
            if (state.wave === 'noise') {
                const bufferSize = ctx.sampleRate * duration;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                sourceNode = ctx.createBufferSource();
                sourceNode.buffer = buffer;
            } else {
                sourceNode = ctx.createOscillator();
                sourceNode.type = state.wave;
                sourceNode.frequency.setValueAtTime(state.freq, t);
                if (state.slide !== 0) {
                    const endFreq = Math.max(1, state.freq + state.slide);
                    sourceNode.frequency.linearRampToValueAtTime(endFreq, t + state.attack + state.hold);
                }
                // VIBRATO LOGIC UPDATE
                if (state.vibrato > 0) {
                    const vibOsc = ctx.createOscillator();
                    vibOsc.frequency.value = state.vib_speed; 
                    const vibGain = ctx.createGain();
                    vibGain.gain.value = state.vibrato;
                    vibOsc.connect(vibGain);
                    vibGain.connect(sourceNode.frequency);
                    vibOsc.start(t);
                    vibOsc.stop(t + duration);
                }
            }

            // 2. Filters
            const hpFilter = ctx.createBiquadFilter();
            hpFilter.type = "highpass";
            hpFilter.frequency.value = state.hp;

            const lpFilter = ctx.createBiquadFilter();
            lpFilter.type = "lowpass";
            lpFilter.frequency.value = state.lp;

            // 3. FX
            const bitShaper = ctx.createWaveShaper();
            if (state.crush < 16) {
                bitShaper.curve = makeBitcrushCurve(state.crush); 
                bitShaper.oversample = 'none';
            }

            const distShaper = ctx.createWaveShaper();
            if (state.drive > 0) {
                distShaper.curve = makeDistortionCurve(state.drive);
                distShaper.oversample = '4x';
            }
            
            const tremoloGain = ctx.createGain();
            if (state.tremolo > 0) {
                const tremOsc = ctx.createOscillator();
                tremOsc.frequency.value = state.tremolo;
                const tremDepth = ctx.createGain();
                tremDepth.gain.value = 0.5; 
                tremOsc.connect(tremDepth);
                tremDepth.connect(tremoloGain.gain);
                tremOsc.start(t);
                tremOsc.stop(t + duration);
            }

            // 6. ENVELOPE
            const envGain = ctx.createGain();
            envGain.gain.setValueAtTime(0, t);
            envGain.gain.linearRampToValueAtTime(state.volume, t + state.attack);
            
            if (state.punch > 0) {
                const punchAmt = (state.punch / 100.0) * 0.5;
                envGain.gain.setValueAtTime(Math.min(1.0, state.volume + punchAmt), t + state.attack);
                envGain.gain.exponentialRampToValueAtTime(state.volume, t + state.attack + 0.05);
            }
            
            envGain.gain.setValueAtTime(state.volume, t + state.attack + state.hold);
            const susVol = state.volume * state.sustain;
            const targetSus = Math.max(0.001, susVol); 
            envGain.gain.exponentialRampToValueAtTime(targetSus, t + state.attack + state.hold + state.decay);
            envGain.gain.setValueAtTime(targetSus, t + state.attack + state.hold + state.decay);
            envGain.gain.exponentialRampToValueAtTime(0.001, t + state.attack + state.hold + state.decay + state.release);

            // 7. Delay
            const delayNode = ctx.createDelay(1.0); 
            const delayGain = ctx.createGain();
            const delayFeedback = ctx.createGain();
            
            if (state.delay > 0) {
                 delayNode.delayTime.value = 0.2;
                 delayGain.gain.value = state.delay; 
                 delayFeedback.gain.value = 0.4;
            }

            sourceNode.connect(hpFilter);
            hpFilter.connect(lpFilter);
            lpFilter.connect(distShaper);
            distShaper.connect(bitShaper);
            bitShaper.connect(tremoloGain);
            tremoloGain.connect(envGain);
            
            if (state.delay > 0) {
                envGain.connect(dest);
                envGain.connect(delayNode);
                delayNode.connect(delayGain);
                delayGain.connect(dest);
                delayNode.connect(delayFeedback);
                delayFeedback.connect(delayNode);
            } else {
                envGain.connect(dest);
            }

            sourceNode.start(t);
            sourceNode.stop(t + duration);

            if (!renderOffline) {
                generateDownloadableBuffer();
            }

            return ctx;
        }

        async function generateDownloadableBuffer() {
            if(!audioCtx) return;
            const context = await playSound(true);
            let renderedBuffer = await context.startRendering();
            lastBuffer = trimSilence(renderedBuffer);
            document.getElementById('val-duration').textContent = lastBuffer.duration.toFixed(2) + 's';
            document.getElementById('download-btn').disabled = false;
        }

        function trimSilence(buffer, threshold = 0.001) {
            const data = buffer.getChannelData(0);
            let lastIndex = data.length;
            for (let i = data.length - 1; i >= 0; i--) {
                if (Math.abs(data[i]) > threshold) {
                    lastIndex = i;
                    break;
                }
            }
            lastIndex = Math.min(data.length, lastIndex + (buffer.sampleRate * 0.05));
            if (lastIndex < data.length) {
                const newCtx = new OfflineAudioContext(1, lastIndex, buffer.sampleRate);
                const newBuf = newCtx.createBuffer(1, lastIndex, buffer.sampleRate);
                newBuf.copyToChannel(data.slice(0, lastIndex), 0);
                return newBuf;
            }
            return buffer;
        }

        /* --- TRIGGER DOWNLOAD (File Picker & NW.js Support) --- */
        async function triggerDownload(blob, ext) {
            const defaultName = `bunny_sfx_${state.wave}_${Date.now()}.${ext}`;
            
            // 1. NW.js Check (If wrapped in NW.js, this bypasses everything and uses Node)
            if (typeof nw !== 'undefined') {
                try {
                    const fs = require('fs');
                    const path = require('path');
                    // Ask user for save location using standard HTML input trick or NW specific dialog
                    // For simplicity in this snippet, we use the web picker if available or a hack
                    // But typically with NW.js we want to use the node buffer
                    const buffer = Buffer.from(await blob.arrayBuffer());
                    
                    // Create a hidden file input to trigger save dialog
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.nwsaveas = defaultName;
                    input.onchange = function() {
                        const filePath = this.value;
                        if (filePath) {
                            fs.writeFileSync(filePath, buffer);
                            // SHOW FILE IN FOLDER
                            nw.Shell.showItemInFolder(filePath);
                            showToast(`Saved to ${path.basename(filePath)}`);
                        }
                    };
                    input.click();
                    return;
                } catch(e) {
                    console.error("NW.js save failed", e);
                }
            }

            // 2. Modern Browser API (Chrome/Edge) - Allows "Save As"
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: defaultName,
                        types: [{
                            description: 'Audio File',
                            accept: { [blob.type]: [`.${ext}`] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast("File saved successfully!");
                    return; 
                } catch (err) {
                    if (err.name !== 'AbortError') console.error(err);
                    return; 
                }
            }

            // 3. Fallback (Classic Download)
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = defaultName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast("File saved to Downloads");
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast bg-zinc-800 border border-zinc-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold flex items-center gap-2';
            toast.innerHTML = `<i class="fa-solid fa-circle-check text-green-500"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateSliderFill(slider) {
            const val = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            let color = '#3b82f6';
            if (slider.classList.contains('slider-osc')) color = '#db2777';
            if (slider.classList.contains('slider-mod')) color = '#818cf8';
            if (slider.classList.contains('slider-env')) color = '#059669';
            if (slider.classList.contains('slider-filter')) color = '#d97706';
            
            slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${val}%, #27272a ${val}%, #27272a 100%)`;
        }
        
        function updateState(key, value) {
            const val = parseFloat(value);
            const label = document.getElementById('val-' + key);
            if(label) {
                if (['freq', 'slide', 'hp', 'lp'].includes(key)) label.textContent = Math.round(val) + ' Hz';
                else if (['attack', 'decay', 'hold', 'release'].includes(key)) label.textContent = val.toFixed(2) + 's';
                else if (['punch', 'vol', 'vibrato', 'drive', 'sustain'].includes(key)) label.textContent = Math.round(val * (key === 'sustain' || key === 'vol' ? 100 : 1)) + '%';
                else if (key === 'crush') label.textContent = val === 16 ? "OFF" : val + " Bit";
                else if (key === 'delay') label.textContent = Math.round(val * 100) + '%';
                else if (key === 'vib_speed') label.textContent = Math.round(val) + ' Hz';
                else label.textContent = val;
            }
        }

        document.querySelectorAll('input[type=range]').forEach(input => {
            updateSliderFill(input);
            input.addEventListener('input', (e) => {
                updateSliderFill(e.target);
                const key = e.target.id.replace('p-', '');
                const val = parseFloat(e.target.value);
                updateState(key, val);
            });
            input.addEventListener('change', (e) => {
                 const key = e.target.id.replace('p-', '');
                 state[key] = parseFloat(e.target.value);
                 playSound(false);
            });
        });

        document.querySelectorAll('.wave-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                state.wave = e.target.dataset.wave;
                document.querySelectorAll('.wave-btn').forEach(b => {
                    b.classList.remove('bg-pink-600', 'text-white');
                    b.classList.add('text-zinc-400');
                });
                e.target.classList.remove('text-zinc-400');
                e.target.classList.add('bg-pink-600', 'text-white');
                playSound(false);
            });
        });

        document.getElementById('manual-play-btn').addEventListener('click', () => playSound(false));

        document.getElementById('download-btn').addEventListener('click', () => {
            if (!lastBuffer) return;
            const fmt = document.getElementById('export-fmt').value;
            if(fmt === 'mp3') downloadMP3(lastBuffer);
            else downloadWAV(lastBuffer);
        });
        
        // --- ADDED MISSING DOWNLOAD FUNCTIONS ---
        function downloadWAV(buffer) {
            const wav = audioBufferToWav(buffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            triggerDownload(blob, 'wav');
        }

        function downloadMP3(buffer) {
            if (!lamejs) {
                console.error("lamejs not found");
                showToast("Error: Encoder not found");
                return;
            }
            const mp3encoder = new lamejs.Mp3Encoder(1, buffer.sampleRate, 128);
            const samples = buffer.getChannelData(0);
            const sampleBlockSize = 1152;
            const mp3Data = [];
            
            // Convert float to int16
            const s = new Int16Array(samples.length);
            for(let i=0; i<samples.length; i++) {
                s[i] = samples[i] < 0 ? samples[i] * 0x8000 : samples[i] * 0x7FFF;
            }
            
            for(let i=0; i<s.length; i+=sampleBlockSize) {
                const chunk = s.subarray(i, i+sampleBlockSize);
                const mp3buf = mp3encoder.encodeBuffer(chunk);
                if(mp3buf.length > 0) mp3Data.push(mp3buf);
            }
            const mp3end = mp3encoder.flush();
            if(mp3end.length > 0) mp3Data.push(mp3end);
            
            const blob = new Blob(mp3Data, { type: 'audio/mp3' });
            triggerDownload(blob, 'mp3');
        }

        function rnd(min, max) { return Math.random() * (max - min) + min; }
        
        function setUI(config) {
            const defaults = {
                wave: 'square', freq: 440, slide: 0, 
                vibrato: 0, vib_speed: 10,
                attack: 0.01, hold: 0.1, decay: 0.1, sustain: 0.5, release: 0.3, punch: 0,
                hp: 0, lp: 20000, crush: 16, tremolo: 0, volume: 0.5,
                drive: 0, delay: 0
            };
            
            // Compatibility
            if (config.sustain !== undefined && config.hold === undefined) { config.hold = config.sustain; config.sustain = 1.0; }
            if (config.decay !== undefined && config.release === undefined) { config.release = config.decay; config.decay = 0.01; }

            const final = {...defaults, ...config};

            for (let key in final) {
                if (key === 'wave') {
                    state.wave = final[key];
                    document.querySelectorAll('.wave-btn').forEach(b => {
                        if(b.dataset.wave === state.wave) {
                            b.classList.remove('text-zinc-400');
                            b.classList.add('bg-pink-600', 'text-white');
                        } else {
                            b.classList.remove('bg-pink-600', 'text-white');
                            b.classList.add('text-zinc-400');
                        }
                    });
                } else {
                    state[key] = final[key];
                    const el = document.getElementById('p-' + key);
                    if (el) {
                        el.value = final[key];
                        updateState(key, final[key]); 
                        updateSliderFill(el);
                    }
                }
            }
            playSound(false);
        }

        function generatePreset(code, label) {
            if(!audioCtx) autoInit();
            let c = {};
            
            if(code === 'random') {
               const waves = ['square', 'sawtooth', 'sine', 'triangle', 'noise'];
               c = { 
                   wave: waves[Math.floor(Math.random()*5)], freq: rnd(100,1500), slide: rnd(-1000,1000), 
                   vibrato: Math.random()>0.8?rnd(10,50):0, vib_speed: rnd(5, 20),
                   attack: rnd(0.01,0.5), hold: rnd(0.05, 0.5), decay: rnd(0.1,0.5), sustain: rnd(0.2, 0.8), release: rnd(0.1, 1.0),
                   punch: rnd(0,100), hp: rnd(0,500), lp: rnd(1000,20000), 
                   crush: Math.random()>0.7?Math.floor(rnd(2,8)):16, 
                   tremolo: Math.random()>0.8?rnd(5,20):0, 
                   drive: Math.random()>0.9?rnd(10,50):0, 
                   delay: Math.random()>0.9?rnd(0.1,0.4):0 
               };
               label = "Randomized";
            }
            // ARCADE
            else if(code==='pickup') c={wave: Math.random()>0.5?'square':'sine', freq: rnd(400,1200), slide: rnd(100,500), attack: 0.01, hold: rnd(0.05,0.1), release: rnd(0.1,0.3), punch: rnd(20,60), crush: 16};
            else if(code==='laser') c={wave: Math.random()>0.5?'sawtooth':'square', freq: rnd(600,1500), slide: rnd(-400,-1000), attack: 0.01, hold: rnd(0.05,0.1), release: rnd(0.1,0.2), hp: rnd(100,400), crush: 16};
            else if(code==='explosion') c={wave: 'noise', freq: 100, attack: 0.01, hold: rnd(0.1,0.3), release: rnd(0.4,1.0), punch: 50, lp: rnd(1000,4000), crush: Math.random()>0.5?rnd(2,6):16, drive: 20};
            else if(code==='powerup') c={wave: Math.random()>0.5?'square':'triangle', freq: rnd(200,500), slide: rnd(300,800), vibrato: rnd(10,30), vib_speed: 10, attack: 0.05, hold: rnd(0.2,0.5), release: rnd(0.2,0.5), tremolo: rnd(5,15)};
            else if(code==='jump') c={wave: 'square', freq: rnd(150,300), slide: rnd(100,300), attack: 0.01, hold: 0.05, release: rnd(0.1,0.2), hp: 100};
            else if(code==='hit') c={wave: Math.random()>0.5?'square':'sawtooth', freq: rnd(100,300), slide: rnd(-50,-200), attack: 0.01, hold: 0.05, release: rnd(0.1,0.2), punch: 80, lp: rnd(2000,8000), crush: Math.floor(rnd(4,12))};
            else if(code==='blip') c={wave: Math.random()>0.5?'square':'sine', freq: rnd(800,2000), slide: 0, attack: 0.01, hold: 0.05, release: 0.05, punch: 0, hp: 0, lp: 20000, crush: 16};
            else if(code==='gameover') c={wave: 'sawtooth', freq: rnd(300,500), slide: rnd(-200,-300), attack: 0.01, hold: 0.4, release: 0.8, vibrato: rnd(15,25), vib_speed: 15, crush: 8, lp: 2000, delay: 0.3};
            else if(code==='arcade_1up') c={wave:'sine', freq:rnd(1000,1500), attack:0.01, hold:0.1, release:0.4};
            else if(code==='arcade_checkpoint') c={wave:'square', freq:rnd(600,800), slide:rnd(100,200), attack:0.01, hold:0.2, release:0.3};
            else if(code==='arcade_shoot') c={wave:'noise', freq:100, attack:0.01, hold:0.05, release:rnd(0.1,0.2), punch:50, hp:500, crush:8};
            else if(code==='arcade_enemy_death') c={wave:'noise', freq:50, attack:0.01, hold:0.1, release:rnd(0.3,0.5), punch:20, lp:1000, crush:4};
            else if(code==='arcade_pause') c={wave:'square', freq:440, attack:0.01, hold:0.1, release:0.1};
            else if(code==='arcade_secret') c={wave:'sine', freq:rnd(1200,2000), attack:0.05, hold:0.3, release:1.0, tremolo:rnd(15,25)};
            
            // MAGIC
            else if(code==='magic_cast') c={wave: 'sine', freq: rnd(800,1500), slide: rnd(200,500), vibrato: rnd(10,30), vib_speed: 10, attack: rnd(0.1,0.3), hold: rnd(0.2,0.4), release: rnd(0.5,1.0), hp: 200, tremolo: rnd(5,10), delay: 0.2};
            else if(code==='magic_fire') c={wave: 'noise', freq: 100, attack: rnd(0.3,0.6), hold: rnd(0.2,0.4), release: rnd(0.5,1.2), hp: 100, lp: rnd(800,1500), crush: 8, drive: 30};
            else if(code==='magic_ice') c={wave: 'sine', freq: rnd(1200,2000), vibrato: rnd(50,80), vib_speed: 20, attack: 0.01, hold: 0.1, release: rnd(0.3,0.6), punch: 50, hp: 500};
            else if(code==='magic_thunder') c={wave: 'noise', freq: 50, attack: 0.01, hold: 0.1, release: rnd(1.0,2.0), punch: 100, lp: rnd(200,500), crush: 4, tremolo: 20, drive: 50};
            else if(code==='magic_heal') c={wave: 'triangle', freq: rnd(300,600), slide: rnd(200,400), vibrato: rnd(5,15), vib_speed: 8, attack: 0.2, hold: 0.5, release: 0.5, lp: 3000};
            else if(code==='magic_dark') c={wave: 'sawtooth', freq: rnd(50,100), slide: rnd(10,30), vibrato: rnd(30,60), vib_speed: 5, attack: 1.0, hold: 1.0, release: 2.0, lp: 400, crush: 4, tremolo: 5};
            else if(code==='magic_warp') c={wave: 'sine', freq: rnd(200,400), slide: rnd(800,1200), attack: 0.05, hold: 0.2, release: 0.4, tremolo: 20, delay: 0.3};
            else if(code==='magic_earth') c={wave: 'noise', freq: 50, attack: 0.01, hold: 0.2, release: 0.5, punch: 100, lp: 150, crush: 2, drive: 60};
            else if(code==='magic_time') c={wave: 'triangle', freq: 800, slide: -800, attack: 0.01, hold: 0.1, release: 2.0, crush: 12, delay: 0.4};
            else if(code==='magic_holy') c={wave: 'sine', freq: rnd(400,600), vibrato: 5, vib_speed: 5, attack: 0.5, hold: 1.0, release: 1.5, hp: 200, lp: 20000, crush: 16, tremolo: 5};
            else if(code==='magic_wind') c={wave:'noise', freq:100, attack:rnd(0.5,1.0), hold:rnd(0.2,0.5), release:rnd(1.0,2.0), hp:100, lp:rnd(300,600)};
            else if(code==='magic_water') c={wave:'noise', freq:100, attack:0.05, hold:0.1, release:rnd(0.3,0.6), punch:20, hp:400, lp:rnd(1500,3000)};
            else if(code==='magic_poison') c={wave:'sawtooth', freq:rnd(100,200), slide:rnd(50,100), attack:0.1, hold:0.4, release:0.8, lp:800, crush:6};
            else if(code==='magic_shield') c={wave:'sine', freq:rnd(100,200), attack:rnd(0.5,1.0), hold:rnd(1.0,2.0), release:rnd(0.5,1.0), tremolo:5};
            else if(code==='magic_necromancy') c={wave:'sawtooth', freq:rnd(60,100), slide:rnd(-10,10), attack:0.1, hold:1.0, release:2.0, lp:500, crush:4};
            else if(code==='magic_summon') c={wave:'triangle', freq:rnd(100,200), slide:rnd(400,600), attack:0.1, hold:0.2, release:2.0, tremolo:10};

            // SCIFI
            else if(code==='scifi_thruster') c={wave:'noise', freq:100, attack:0.2, hold:0.5, release:0.5, lp:rnd(200,400), tremolo:10};
            else if(code==='scifi_scanner') c={wave:'sine', freq:rnd(1200,1800), vibrato:60, vib_speed: 30, attack:0.1, hold:0.5, release:0.5};
            else if(code==='scifi_droid') c={wave:Math.random()>0.5?'sine':'square', freq:rnd(500,1500), slide:rnd(-500,500), vibrato:rnd(20,50), vib_speed: rnd(20,40), attack:0.01, hold:0.05, release:0.1};
            else if(code==='scifi_forcefield') c={wave:'sine', freq:rnd(100,200), tremolo:20, attack:0.5, hold:1.0, release:1.0};
            else if(code==='scifi_alarm') c={wave:'square', freq:rnd(800,1200), tremolo:10, attack:0.01, hold:0.5, release:0.5};
            else if(code==='scifi_laser_cannon') c={wave:'sawtooth', freq:rnd(200,400), slide:rnd(-200,-400), attack:0.01, hold:0.1, release:0.4, punch:50, lp:5000, crush:8};
            else if(code==='scifi_warp_drive') c={wave:'sine', freq:rnd(100,200), slide:rnd(800,1500), attack:1.0, hold:1.0, release:2.0, tremolo:10};
            else if(code==='scifi_teleport') c={wave:'sine', freq:rnd(200,400), slide:rnd(1500,2500), attack:0.1, hold:0.2, release:0.5, tremolo:60};
            else if(code==='scifi_data') c={wave:'square', freq:rnd(1000,3000), slide:rnd(-500,500), attack:0.001, hold:0.02, release:0.02, crush:8};
            else if(code==='scifi_powerdown') c={wave:'sawtooth', freq:rnd(400,600), slide:rnd(-350,-550), attack:0.01, hold:0.5, release:1.0, lp:2000};
            else if(code==='scifi_shield_hit') c={wave:'noise', freq:100, attack:0.01, hold:0.05, release:0.2, punch:50, hp:500, lp:5000};

            // RPG
            else if(code==='rpg_sword') c={wave:'noise', freq:100, attack:0.05, hold:0.1, release:0.2, hp:200, lp:rnd(1000,2000)};
            else if(code==='rpg_block') c={wave:'noise', freq:100, attack:0.01, hold:0.05, release:0.1, punch:80, hp:500, lp:rnd(3000,6000), crush:8};
            else if(code==='rpg_potion') c={wave:'sine', freq:rnd(300,600), slide:rnd(200,400), attack:0.05, hold:0.2, release:0.2};
            else if(code==='rpg_levelup') c={wave:'triangle', freq:rnd(400,600), slide:rnd(400,800), vibrato:10, vib_speed: 8, attack:0.1, hold:0.5, release:1.5};
            else if(code==='rpg_crit') c={wave:'sawtooth', freq:rnd(100,200), attack:0.01, hold:0.1, release:0.3, punch:100, hp:0, lp:rnd(2000,5000), crush:6};
            else if(code==='rpg_footstep') c={wave:'noise', freq:100, attack:0.01, hold:0.02, release:0.05, lp:rnd(300,600)};
            else if(code==='rpg_quest') c={wave:'sine', freq:rnd(800,1200), attack:0.01, hold:0.1, release:0.5};
            else if(code==='rpg_bow') c={wave:'noise', freq:100, attack:0.01, hold:0.05, release:0.1, punch:50, hp:1000};
            else if(code==='rpg_growl') c={wave:'sawtooth', freq:rnd(60,100), attack:0.2, hold:0.5, release:0.5, lp:800, crush:6, tremolo:20, drive: 40};
            else if(code==='rpg_menu') c={wave:'sine', freq:rnd(1000,1500), attack:0.001, hold:0.01, release:0.05};
            else if(code==='rpg_miss') c={wave:'triangle', freq:rnd(400,600), slide:rnd(-200,-400), attack:0.01, hold:0.05, release:0.1};

            // UI
            else if(code==='ui_click') c={wave:'triangle', freq:rnd(1500,2500), attack:0.001, hold:0.01, release:0.05, punch:80, hp:500};
            else if(code==='ui_switch') c={wave:'square', freq:rnd(500,800), attack:0.001, hold:0.02, release:0.08, punch:20, lp:10000};
            else if(code==='ui_confirm') c={wave:'sine', freq:rnd(800,1200), slide:rnd(200,400), attack:0.01, hold:0.1, release:0.3};
            else if(code==='ui_error') c={wave:'sawtooth', freq:rnd(100,150), slide:-20, attack:0.01, hold:0.1, release:0.2, lp:800, crush:8};
            else if(code==='ui_back') c={wave:'triangle', freq:rnd(600,800), slide:rnd(-200,-300), attack:0.01, hold:0.05, release:0.2};
            else if(code==='ui_type') c={wave:'noise', freq:100, attack:0.001, hold:0.01, release:0.03, punch:90, hp:1000, lp:8000};
            else if(code==='ui_notify') c={wave:'sine', freq:rnd(1000,1500), attack:0.01, hold:0.1, release:0.5, punch:20, tremolo:10};
            else if(code==='ui_hover') c={wave:'sine', freq:rnd(3000,5000), attack:0.001, hold:0.005, release:0.02, hp:1000};
            else if(code==='ui_purchase') c={wave:'square', freq:rnd(1500,2000), attack:0.01, hold:0.05, release:0.2, punch:50};
            else if(code==='ui_delete') c={wave:'sawtooth', freq:rnd(300,500), slide:rnd(-200,-300), attack:0.01, hold:0.1, release:0.3, lp:10000, crush:8};
            else if(code==='ui_popup') c={wave:'sine', freq:rnd(600,800), slide:rnd(100,200), attack:0.01, hold:0.05, release:0.2};
            else if(code==='ui_toggle_on') c={wave:'sine', freq:1000, attack:0.001, hold:0.05, release:0.05};
            else if(code==='ui_toggle_off') c={wave:'sine', freq:500, attack:0.001, hold:0.05, release:0.05};

            // VOICE
            else if(code==='voice_animal_high') c={wave:'triangle', freq:rnd(800,1200), slide:rnd(50,200), attack:0.01, hold:0.05, release:0.05};
            else if(code==='voice_animal_med') c={wave:'square', freq:rnd(400,600), slide:rnd(50,150), attack:0.01, hold:0.05, release:0.08, lp:5000};
            else if(code==='voice_animal_low') c={wave:'sawtooth', freq:rnd(100,200), slide:rnd(-20,50), attack:0.02, hold:0.1, release:0.1, lp:1500, crush:12};
            else if(code==='voice_robot') c={wave:'sawtooth', freq:rnd(300,600), tremolo:20, attack:0.01, hold:0.1, release:0.1, lp:3000, crush:4};
            else if(code==='voice_whistle') c={wave:'sine', freq:rnd(1000,1500), slide:rnd(200,500), attack:0.05, hold:0.1, release:0.1};
            else if(code==='voice_ghost') c={wave:'sine', freq:rnd(400,600), slide:rnd(-50,50), vibrato:rnd(20,40), vib_speed: 15, attack:0.1, hold:0.5, release:1.0, tremolo:15, delay: 0.4};
            else if(code==='voice_demon') c={wave:'sawtooth', freq:rnd(50,100), attack:0.05, hold:0.3, release:0.5, punch:20, hp:0, lp:800, crush:4, drive: 30};
            else if(code==='voice_alien') c={wave:'triangle', freq:rnd(500,1000), slide:rnd(-300,300), vibrato:80, vib_speed: 30, attack:0.01, hold:0.1, release:0.3, crush:12};
            else if(code==='voice_insect') c={wave:'square', freq:rnd(2000,3000), attack:0.001, hold:0.01, release:0.02, lp:1000};
            // RETRO
            else if(code==='retro_noise_short') c={wave:'noise', freq:100, attack:0.001, hold:0.02, release:rnd(0.05,0.1), hp:100, lp:10000, crush:4};
            else if(code==='retro_square_slide') c={wave:'square', freq:rnd(200,400), slide:rnd(400,800), attack:0.01, hold:0.1, release:0.1};
            else if(code==='retro_fall') c={wave:'square', freq:rnd(600,1000), slide:rnd(-400,-800), attack:0.01, hold:0.1, release:0.3, crush:8};
            else if(code==='retro_buzz') c={wave:'sawtooth', freq:60, attack:0.01, hold:0.5, release:0.1, lp:rnd(10000,20000), crush:2, tremolo:rnd(10,20)};
            else if(code==='retro_modem') c={wave:'square', freq:rnd(1000,2000), vibrato:80, vib_speed: 60, attack:0.01, hold:0.5, release:0.5, crush:4};
            else if(code==='retro_teleport') c={wave:'square', freq:rnd(200,400), slide:rnd(600,1000), attack:0.01, hold:0.1, release:0.5, crush:8, tremolo:20};
            else if(code==='retro_engine') c={wave:'square', freq:rnd(50,100), attack:0.1, hold:1.0, release:0.5, lp:800, crush:8, tremolo:rnd(15,25)};
            else if(code==='retro_glitch') c={wave:Math.random()>0.5?'square':'sawtooth', freq:rnd(100,1000), slide:rnd(-500,500), attack:0.001, hold:0.05, release:0.1, punch:rnd(50,100), hp:0, lp:20000, crush:Math.random()>0.7?Math.floor(rnd(2,6)):16, tremolo:20};

            addToHistory(label, c);
            setUI(c);
        }

        // WAV Helper (Standard)
        function audioBufferToWav(buffer) {
            const numChannels = 1;
            const sampleRate = buffer.sampleRate;
            const format = 1;
            const bitDepth = 16;
            const samples = buffer.getChannelData(0);
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            const bufferSize = 44 + samples.length * bytesPerSample;
            const arrayBuffer = new ArrayBuffer(bufferSize);
            const view = new DataView(arrayBuffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * bytesPerSample, true);
            floatTo16BitPCM(view, 44, samples);
            return arrayBuffer;
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }
        function floatTo16BitPCM(output, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }
    </script>
</body>
</html>